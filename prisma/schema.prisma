generator client {
  provider = "prisma-client-js"
  output     = "../prisma/generated"
}

datasource db {
  provider = "postgresql"
}

model Tenant {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  status           String   @default("ACTIVE") // ACTIVE, INACTIVE
  subscriptionTier String   @default("FREE") // FREE, PRO, ENTERPRISE
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  users     User[]
  divisions Division[]
  locations Location[]
  machines  Machine[]
  calls     Call[]
}

model User {
  id         String    @id @default(cuid())
  name       String?
  email      String    @unique
  password   String // Hashed
  role       String    @default("TEAM") // ADMIN, TEAM
  tenantId   String
  tenant     Tenant    @relation(fields: [tenantId], references: [id])
  divisionId String?
  division   Division? @relation(fields: [divisionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  respondedCalls Call[] @relation("RespondedCalls")
}

model Division {
  id        String   @id @default(cuid())
  name      String
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  users     User[]
  targetedCalls Call[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Location {
  id        String    @id @default(cuid())
  name      String
  tenantId  String
  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  machines  Machine[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Machine {
  id         String   @id @default(cuid())
  name       String
  code       String
  qrCodeUrl  String?
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  calls      Call[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
}

model Call {
  id        String  @id @default(cuid())
  machineId String
  machine   Machine @relation(fields: [machineId], references: [id])
  tenantId  String
  tenant    Tenant  @relation(fields: [tenantId], references: [id])
  status    String  @default("ACTIVE")
  number    Int     @default(autoincrement())

  reportedAt  DateTime  @default(now())
  respondedAt DateTime?
  resolvedAt  DateTime?

  targetDivisionId String?
  targetDivision   Division? @relation(fields: [targetDivisionId], references: [id])

  responderId String?
  responder   User?   @relation("RespondedCalls", fields: [responderId], references: [id])

  content String?

  // PENTING: Perubahan di sini
  reports Report[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Report {
  id        String   @id @default(cuid())
  content   String
  callId    String
  
  // TAMBAHKAN onDelete: Cascade di sini
  // Ini memastikan saat Call dihapus, Report yang terkait juga ikut terhapus
  call      Call     @relation(fields: [callId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
}